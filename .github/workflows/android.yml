name: Android CI

on: [pull_request, push]

permissions:
  contents: read

jobs:
  android-build:
    strategy:
      fail-fast: true
      matrix:
        target:
        - android-arm
        - android-arm64
        - android-x86
        - android-x86_64

    runs-on: ubuntu-latest
        
    steps:
    - uses: actions/checkout@v3
    - name: config
      run: |
        mkdir build-${{ matrix.target }}
        mkdir -p install/${{ matrix.target }}
        cd build-${{ matrix.target }}
        PATH=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH
        ../Configure ${{ matrix.target }} --prefix=$(cd ../install/${{ matrix.target }}; pwd)

    - name: make
      run: |
        PATH=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH
        make -s -j4
      working-directory: build-${{ matrix.target }}

    - name: make install
      run: make install_sw
      working-directory: build-${{ matrix.target }}

    - name: 'Upload Artifact'
      uses: actions/upload-artifact@v3
      with:
        name: ${{ matrix.target }}-build
        path: install/${{ matrix.target }}